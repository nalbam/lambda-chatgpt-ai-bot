# 4-Stage Workflow Engine Overview

## 개요

Lambda Slack AI Bot은 복잡한 다중 작업 요청을 지능적으로 처리하는 4단계 워크플로우 엔진을 구현했습니다.

## 🎯 핵심 기능

### 복합 요청 처리
- "AI에 대해 설명하고 로봇 이미지도 그려줘" 같은 다중 작업 요청
- 텍스트 생성과 이미지 생성을 동시에 처리
- 이미지 분석과 설명 요청 조합
- 스레드 요약 및 정리 기능

### 즉시 응답 시스템
- 각 작업 완료시 바로 Slack에 전송
- AI 요약 단계 제거로 자연스러운 대화 흐름
- 스트리밍 텍스트 응답과 즉시 이미지 업로드

## 🔄 4단계 워크플로우

### 1단계: 사용자 의도 파악
- OpenAI가 사용자 메시지를 분석
- 봇의 능력 목록과 함께 전송
- 필요한 작업들을 JSON 형태로 추출

**예시 분석:**
```json
{
  "user_intent": "AI 설명과 로봇 이미지 생성 요청",
  "required_tasks": [
    {
      "task_id": "explain_ai",
      "task_type": "text_generation",
      "description": "AI에 대한 설명",
      "input_data": "AI에 대해 설명해줘"
    },
    {
      "task_id": "draw_robot",
      "task_type": "image_generation", 
      "description": "로봇 이미지 생성",
      "input_data": "로봇 이미지"
    }
  ]
}
```

### 2단계: 작업 계획 수립
- 추출된 작업들을 실행 가능한 형태로 변환
- 의존성과 우선순위 고려
- 컨텍스트 정보 추가 (스레드 히스토리, 업로드된 이미지 등)

### 3단계: 직접 실행 및 즉시 회신
각 작업이 완료되는 즉시 Slack에 결과 전송:

**텍스트 생성:**
- GPT-4o로 응답 생성
- 실시간 스트리밍으로 Slack 전송
- 800자마다 중간 업데이트

**이미지 생성:**
- 한국어 → 영어 자동 번역
- DALL-E 3으로 이미지 생성
- OpenAI URL에서 다운로드
- Slack에 즉시 업로드

**이미지 분석:**
- GPT-4 Vision으로 분석
- 스트리밍으로 분석 결과 전송

**스레드 요약:**
- 스레드 내 모든 메시지 수집
- GPT-4o로 지능형 요약 생성
- 구조화된 요약 결과 전송

### 4단계: 완료 알림
- "✅ 모든 작업이 완료되었습니다" 메시지
- 작업 수행 통계 로깅

## 🚀 처리 흐름 예시

**사용자 요청:** "AI에 대해 설명하고 로봇 이미지도 그려줘"

```
1️⃣ 의도 분석: "텍스트 생성 + 이미지 생성 조합 요청"
2️⃣ 작업 계획: [AI 설명 작업, 로봇 이미지 작업]
3️⃣ 실행 & 회신:
   ├── AI 설명 스트리밍 전송 ✅
   └── 로봇 이미지 생성 & 업로드 ✅
4️⃣ 완료: "모든 작업 완료" ✅
```

## 💡 기술적 특징

### 지능형 분기 처리
- 복합 요청 자동 감지
- 단순 요청은 기본 처리
- 복잡한 요청만 워크플로우 엔진 사용

### 오류 처리 및 복구
- 각 단계별 독립적 오류 처리
- 실패한 작업은 오류 메시지 즉시 전송
- 다른 작업은 계속 진행

### 성능 최적화
- 작업 병렬 처리 지원
- 불필요한 AI 요약 단계 제거
- 메모리 효율적인 스트리밍

## 🔧 구현 컴포넌트

- **WorkflowEngine**: 4단계 워크플로우 조정
- **TaskExecutor**: 개별 작업 실행
- **SlackMessageUtils**: Slack 통합 유틸리티
- **MessageHandler**: 워크플로우 진입점

이 구조를 통해 봇은 단순한 질문부터 복잡한 다중 작업 요청까지 모두 자연스럽고 효율적으로 처리할 수 있습니다.